/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * ControlCalidadDiario.java
 *
 * Created on 06/11/2011, 22:18:52
 */
package metalsoft.presentacion;

import java.awt.Window;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import metalsoft.datos.jpa.entity.Detalleejecucionplanificacion;
import metalsoft.datos.jpa.entity.Detalleejecucionplanificacioncalidad;
import metalsoft.datos.jpa.entity.Detalleplanificacioncalidad;
import metalsoft.datos.jpa.entity.Detalleplanificacionproduccion;
import metalsoft.datos.jpa.entity.Detalleproductopresupuesto;
import metalsoft.datos.jpa.entity.Pedido;
import metalsoft.datos.jpa.entity.Pieza;
import metalsoft.datos.jpa.entity.Procesocalidad;
import metalsoft.datos.jpa.entity.Producto;
import metalsoft.negocio.gestores.GestorControlCalidadDiario;
import metalsoft.negocio.gestores.NumerosAMostrar;
import metalsoft.util.Fecha;
import org.jdesktop.swingx.calendar.DateSelectionModel.SelectionMode;
import org.jdesktop.swingx.decorator.HighlightPredicate;
import org.jdesktop.swingx.decorator.HighlighterFactory.UIColorHighlighter;
import org.jdesktop.swingx.treetable.AbstractMutableTreeTableNode;
import org.jdesktop.swingx.treetable.DefaultMutableTreeTableNode;
import org.jdesktop.swingx.treetable.DefaultTreeTableModel;
import org.jdesktop.swingx.treetable.MutableTreeTableNode;
import org.jdesktop.swingx.treetable.TreeTableModel;

/**
 *
 * @author Nino
 */
public class ControlCalidadDiario extends javax.swing.JDialog {

    private static Window owner;
    private ArrayList<String> listColumnNamesTreeTable;
    private GestorControlCalidadDiario gestor;
    private List<Detalleplanificacioncalidad> lstDetallePlanificacion;

    /** Creates new form ControlCalidadDiario */
    public ControlCalidadDiario(java.awt.Frame parent, boolean modal) {
        super(owner);
        gestor = new GestorControlCalidadDiario();
        initComponents();
        iniciarTreeTable();
        buscarPedidosEnEjecucionOAEjecutar();
        cargarTreeTable();
    }

    public static void setOwner(Window owner) {
        ControlCalidadDiario.owner = owner;
    }

    private void iniciarTreeTable() {
        listColumnNamesTreeTable = new ArrayList<String>();
        listColumnNamesTreeTable.add("Detalle");
        listColumnNamesTreeTable.add("Inicio Previsto");
        listColumnNamesTreeTable.add("Fin Previsto");
        listColumnNamesTreeTable.add("Inicio Real");
        listColumnNamesTreeTable.add("Fin Real");
        listColumnNamesTreeTable.add("Estado");
        listColumnNamesTreeTable.add("Empleado");
        listColumnNamesTreeTable.add("MÃ¡quina");

        DefaultMutableTreeTableNode raiz = new DefaultMutableTreeTableNode("");

        TreeTableModel treeTableModel = new TablaProduccionDiariaModel(raiz, listColumnNamesTreeTable);
        trtDetalleDiario.setColumnControlVisible(true);
        trtDetalleDiario.setAutoCreateRowSorter(true);
        trtDetalleDiario.setSelectionMode(SelectionMode.SINGLE_SELECTION.ordinal());
        trtDetalleDiario.setTreeTableModel(treeTableModel);
        trtDetalleDiario.setRootVisible(true);
        trtDetalleDiario.setHorizontalScrollEnabled(true);
        trtDetalleDiario.setHighlighters(
                new UIColorHighlighter(HighlightPredicate.ODD));
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        trtDetalleDiario = new org.jdesktop.swingx.JXTreeTable();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder("Detalle"));

        jScrollPane1.setViewportView(trtDetalleDiario);

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 701, Short.MAX_VALUE)
                .addContainerGap())
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 495, Short.MAX_VALUE)
                .addContainerGap())
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 753, Short.MAX_VALUE)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 555, Short.MAX_VALUE)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(ControlCalidadDiario.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(ControlCalidadDiario.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(ControlCalidadDiario.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(ControlCalidadDiario.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        /* Create and display the dialog */
        java.awt.EventQueue.invokeLater(new Runnable() {

            public void run() {
                ControlCalidadDiario dialog = new ControlCalidadDiario(new javax.swing.JFrame(), true);
                dialog.addWindowListener(new java.awt.event.WindowAdapter() {

                    @Override
                    public void windowClosing(java.awt.event.WindowEvent e) {
                        System.exit(0);
                    }
                });
                dialog.setVisible(true);
            }
        });
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private org.jdesktop.swingx.JXTreeTable trtDetalleDiario;
    // End of variables declaration//GEN-END:variables

    private void buscarPedidosEnEjecucionOAEjecutar() {
        lstDetallePlanificacion = gestor.buscarPlanificacionDiaria();
    }

    private void cargarTreeTable() {
        DefaultMutableTreeTableNode raiz = new DefaultMutableTreeTableNode("---");
        trtDetalleDiario.removeAll();
        trtDetalleDiario.setTreeTableModel(new TablaProduccionDiariaModel(raiz, listColumnNamesTreeTable));

        Map<Long, PedidoNode> mapPedido = new HashMap<Long, PedidoNode>();
        Map<String, ProductoNode> mapProducto = new HashMap<String, ProductoNode>();
        Map<String, PiezaNode> mapPieza = new HashMap<String, PiezaNode>();
        for (Detalleplanificacioncalidad detalleplanificacion : lstDetallePlanificacion) {
            Pedido pedido = detalleplanificacion.getIdplanificacioncalidad().getPedido();
            Producto producto = detalleplanificacion.getProducto();
            Pieza pieza = detalleplanificacion.getPieza();
            Procesocalidad procesocalidad = detalleplanificacion.getProcesocalidad();

            PedidoNode pedidoNode = null;
            if (mapPedido.containsKey(pedido.getIdpedido())) {
                pedidoNode = mapPedido.get(pedido.getIdpedido());
            } else {
                pedidoNode = new PedidoNode(pedido);
                raiz.add(pedidoNode);
                mapPedido.put(pedido.getIdpedido(), pedidoNode);
            }

            ProductoNode productoNode = null;
            String keyProducto = String.valueOf(pedidoNode.getPedido().getIdpedido()) + String.valueOf(producto.getIdproducto()) + String.valueOf(detalleplanificacion.getIndexproducto());
            if (mapProducto.containsKey(keyProducto)) {
                productoNode = mapProducto.get(keyProducto);
            } else {
                productoNode = new ProductoNode(producto);
                pedidoNode.add(productoNode);
                mapProducto.put(keyProducto, productoNode);
            }

            PiezaNode piezaNode = new PiezaNode(pieza);
            String keyPieza = String.valueOf(pedidoNode.getPedido().getIdpedido()) + String.valueOf(producto.getIdproducto()) + String.valueOf(detalleplanificacion.getIndexproducto()) + String.valueOf(pieza.getIdpieza() + String.valueOf(detalleplanificacion.getIndexpieza()));
            if (mapPieza.containsKey(keyPieza)) {
                piezaNode = mapPieza.get(keyPieza);
            } else {
                piezaNode = new PiezaNode(pieza);
                productoNode.add(piezaNode);
                mapPieza.put(keyPieza, piezaNode);
            }


            ProcesoCalidadNode etapaProduccionNode = new ProcesoCalidadNode(detalleplanificacion, detalleplanificacion.getIddetalleejecucionplanificacioncalidad());

            piezaNode.add(etapaProduccionNode);

        }

        trtDetalleDiario.updateUI();
        trtDetalleDiario.expandAll();
        trtDetalleDiario.packAll();
    }

    class ProductoNode extends AbstractMutableTreeTableNode {

        private metalsoft.datos.jpa.entity.Producto producto;
        private metalsoft.datos.jpa.entity.Detalleproductopresupuesto detalleProductoPresupuesto;
        private Integer indexProducto = 1;

        public ProductoNode(metalsoft.datos.jpa.entity.Producto producto) {
            this.producto = producto;
        }

        public Object getValueAt(int i) {
            switch (i) {
                case 0:
                    return producto.getNombre() + "-" + indexProducto;
            }
            return "";
        }

        public int getColumnCount() {
            return listColumnNamesTreeTable.size();
        }

        public Detalleproductopresupuesto getDetalleProductoPresupuesto() {
            return detalleProductoPresupuesto;
        }

        public void setDetalleProductoPresupuesto(Detalleproductopresupuesto detalleProductoPresupuesto) {
            this.detalleProductoPresupuesto = detalleProductoPresupuesto;
        }

        public Producto getProducto() {
            return producto;
        }

        public void setProducto(Producto producto) {
            this.producto = producto;
        }

        public Integer getIndexProducto() {
            return indexProducto;
        }

        public void setIndexProducto(Integer indexProducto) {
            this.indexProducto = indexProducto;
        }
    }

    class PedidoNode extends AbstractMutableTreeTableNode {

        private metalsoft.datos.jpa.entity.Pedido pedido;
        private metalsoft.datos.jpa.entity.Detalleproductopresupuesto detalleProductoPresupuesto;
        private Integer indexProducto = 1;

        public PedidoNode(metalsoft.datos.jpa.entity.Pedido pedido) {
            this.pedido = pedido;
        }

        public Object getValueAt(int i) {
            switch (i) {
                case 0:
                    return NumerosAMostrar.getNumeroString(NumerosAMostrar.NRO_PEDIDO, pedido.getNropedido());
            }
            return "";
        }

        public int getColumnCount() {
            return listColumnNamesTreeTable.size();
        }

        public Detalleproductopresupuesto getDetalleProductoPresupuesto() {
            return detalleProductoPresupuesto;
        }

        public void setDetalleProductoPresupuesto(Detalleproductopresupuesto detalleProductoPresupuesto) {
            this.detalleProductoPresupuesto = detalleProductoPresupuesto;
        }

        public Pedido getPedido() {
            return pedido;
        }

        public void setPedido(Pedido pedido) {
            this.pedido = pedido;
        }

        public Integer getIndexProducto() {
            return indexProducto;
        }

        public void setIndexProducto(Integer indexProducto) {
            this.indexProducto = indexProducto;
        }
    }

    class PiezaNode extends AbstractMutableTreeTableNode {

        private metalsoft.datos.jpa.entity.Pieza pieza;
        private int indexPieza = 1;

        public PiezaNode(metalsoft.datos.jpa.entity.Pieza pieza) {
            this.pieza = pieza;
        }

        public List<MutableTreeTableNode> getChildren() {
            return children;
        }

        public Object getValueAt(int i) {
            switch (i) {
                case 0:
                    return pieza.getNombre() + "-" + indexPieza;
            }
            return "";
        }

        public int getIndexPieza() {
            return indexPieza;
        }

        public void setIndexPieza(int indexPieza) {
            this.indexPieza = indexPieza;
        }

        public int getColumnCount() {
            return listColumnNamesTreeTable.size();
        }

        public metalsoft.datos.jpa.entity.Pieza getPieza() {
            return pieza;
        }
    }

    class ProcesoCalidadNode extends AbstractMutableTreeTableNode {

        private Detalleplanificacioncalidad dpp;
        private Detalleejecucionplanificacioncalidad dep;

        public ProcesoCalidadNode(Detalleplanificacioncalidad dpp, Detalleejecucionplanificacioncalidad dep) {
            this.dpp = dpp;
            this.dep = dep;
        }

        @Override
        public Object getValueAt(int i) {
            try {
                switch (i) {
                    case 0:
                        return dpp.getProcesocalidad().getNombre();
                    case 1:
                        return Fecha.parseToStringFechaHora(Fecha.dateWithSpecificValues(dpp.getFechainicio(), dpp.getHorainicio().getHours(), dpp.getHorainicio().getMinutes(), dpp.getHorainicio().getSeconds()));
                    case 2:
                        return Fecha.parseToStringFechaHora(Fecha.dateWithSpecificValues(dpp.getFechafin(), dpp.getHorafin().getHours(), dpp.getHorafin().getMinutes(), dpp.getHorafin().getSeconds()));
                    case 3:
                        if (dep != null) {
                            return Fecha.parseToStringFechaHora(Fecha.dateWithSpecificValues(dep.getFechainicio(), dep.getHorainicio().getHours(), dep.getHorainicio().getMinutes(), dep.getHorainicio().getSeconds()));
                        } else {
                            return "";
                        }
                    case 4:
                        if (dep != null) {
                            return Fecha.parseToStringFechaHora(Fecha.dateWithSpecificValues(dep.getFechafin(), dep.getHorafin().getHours(), dep.getHorafin().getMinutes(), dep.getHorafin().getSeconds()));
                        } else {
                            return "";
                        }
                    case 5:
                        if (dep != null) {
                            return dep.getEjecucionprocesocalidad().getEstado().getNombre();
                        } else {
                            return "";
                        }
                    case 6:
                        if (dep != null) {
                            return dep.getEjecucionprocesocalidad().getEmpleado().getNombre() + " " + dep.getEjecucionprocesocalidad().getEmpleado().getApellido();
                        } else {
                            return dpp.getEmpleado().getNombre() + " " + dpp.getEmpleado().getApellido();
                        }
                    case 7:
                        if (dep != null && dep.getEjecucionprocesocalidad().getMaquina() != null) {
                            return dep.getEjecucionprocesocalidad().getMaquina().getNombre();
                        } else {
                            if (dpp.getMaquina() != null) {
                                return dpp.getMaquina().getNombre();
                            } else {
                                return "";
                            }
                        }
                }
            } catch (NullPointerException ex) {
                return "----";
            }
            return "";
        }

        public int getColumnCount() {
            return listColumnNamesTreeTable.size();
        }
    }

    class TablaProduccionDiariaModel extends DefaultTreeTableModel {

        private TablaProduccionDiariaModel(DefaultMutableTreeTableNode raiz, ArrayList<String> listColumnNamesTreeTable) {
            super(raiz, listColumnNamesTreeTable);
        }

        @Override
        public boolean isCellEditable(Object node, int column) {
            return false;
        }
    }
}
